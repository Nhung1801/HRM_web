<!-- <p-confirmPopup></p-confirmPopup> -->

<div class="grid">
    <div class="col-12">
        <p-toolbar styleClass="mb-2">
            <div class="">
                <strong class="font-size-16">Bảng KPI</strong>
                <p-breadcrumb
                    [model]="items"
                    [home]="{ icon: 'pi pi-home' }"
                ></p-breadcrumb>
            </div>
            <div class="toast-container">
                <p-messages
                    [(value)]="messages"
                    [enableService]="false"
                    [closable]="false"
                ></p-messages>
            </div>
            <ng-template pTemplate="right">
                <div class="flex gap-2">
                    <!-- <button
                        [routerLink]="['/staff-position/create']"
                        pButton
                        pRipple
                        icon="pi pi-plus"
                        label="Thêm vị trí"
                        (click)="show()"
                    ></button> -->
                    <!-- <p-button
                        label="Xóa"
                        [disabled]="
                            this.selectedStaffPosition.length > 0 ? false : true
                        "
                        (click)="handleOnDeleteMultiple($event)"
                        severity="danger"
                    ></p-button> -->
                </div>
            </ng-template>
        </p-toolbar>
        <div class="card">
            <div class="flex gap-3 justify-content-between">
                <div class="flex flex-column">
                    <p-autoComplete
                        [style]="{ height: '43px', width: '100%' }"
                        [(ngModel)]="selectedEmployee"
                        [suggestions]="filteredEmployees"
                        (completeMethod)="searchEmployee($event)"
                        [field]="'displayName'"
                        [forceSelection]="true"
                        [showClear]="true"
                        placeholder="Tìm kiếm tên bảng KPI"
                        (onSelect)="loadKpiData()"
                        (onClear)="loadKpiData()"
                    >
                    </p-autoComplete>
                </div>
                <div class="flex gap-3">
                    <div class="flex flex-column">
                        <p-treeSelect
                            [options]="treeData"
                            [(ngModel)]="selectedNode"
                            [placeholder]="'Chọn đơn vị'"
                            [showClear]="true"
                            [style]="{ width: '300px' }"
                            (onNodeSelect)="loadKpiData()"
                            (onClear)="loadKpiData()"
                        ></p-treeSelect>
                    </div>
                    <div
                        class="flex flex-column"
                        *ngIf="
                            this.permisionHelper.hasPermissions([
                                permissionConstant.ManageKPICreate
                            ])
                        "
                    >
                        <button
                            pButton
                            pRipple
                            icon="pi pi-plus"
                            label="Thêm mới"
                            (click)="openCreateKpiVisible()"
                        ></button>
                    </div>
                </div>
            </div>

            <div class="table-section" style="margin-top: 20px">
                <p-table
                    [value]="kpilist"
                    [rows]="pageSize"
                    [totalRecords]="totalRecords"
                    [paginator]="false"
                    responsiveLayout="scroll"
                    (onPage)="onPageChange($event)"
                    styleClass="p-datatable-striped"
                >
                    <ng-template pTemplate="header">
                        <tr>
                            <th>
                                <p-tableHeaderCheckbox></p-tableHeaderCheckbox>
                            </th>
                            <th style="width: 20%">Tên bảng tổng hợp KPI</th>
                            <th style="width: 20%">Đơn vị áp dụng</th>
                            <th style="width: 30%">Vị trí áp dụng</th>
                            <th style="width: 20%">Thời gian</th>
                            <th
                                *ngIf="
                                    this.permisionHelper.hasPermissions([
                                        permissionConstant.ManageKPIEdit
                                    ]) ||
                                    this.permisionHelper.hasPermissions([
                                        permissionConstant.ManageKPIDelete
                                    ])
                                "
                                style="width: 20%"
                            >
                                Hành động
                            </th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-rowData let-i="rowIndex">
                        <tr>
                            <td>
                                <p-tableCheckbox
                                    [value]="rowData"
                                ></p-tableCheckbox>
                            </td>
                            <td [routerLink]="['/detail-kpi', rowData.id]">
                                {{ rowData.nameKpiTable }}
                            </td>
                            <td>{{ rowData.organizationName }}</td>
                            <td>
                                <span
                                    *ngIf="
                                        isAllPositionsMatch(
                                            rowData.positionNames
                                        )
                                    "
                                >
                                    Tất cả vị trí
                                </span>
                                <span
                                    *ngIf="
                                        !isAllPositionsMatch(
                                            rowData.positionNames
                                        )
                                    "
                                >
                                    <span
                                        *ngIf="
                                            rowData.positionNames.length <= 100
                                        "
                                    >
                                        {{ rowData.positionNames }}
                                    </span>
                                    <span
                                        *ngIf="
                                            rowData.positionNames.length > 100
                                        "
                                    >
                                        <span *ngIf="!expandedRows[rowData.id]">
                                            {{
                                                rowData.positionNames
                                                    | slice : 0 : 100
                                            }}...
                                            <a
                                                href="#"
                                                (click)="
                                                    toggleRow(
                                                        rowData.id,
                                                        $event
                                                    )
                                                "
                                                >Xem thêm</a
                                            >
                                        </span>
                                        <span *ngIf="expandedRows[rowData.id]">
                                            {{ rowData.positionNames }}
                                            <a
                                                href="#"
                                                (click)="
                                                    toggleRow(
                                                        rowData.id,
                                                        $event
                                                    )
                                                "
                                                >Ẩn bớt</a
                                            >
                                        </span>
                                    </span>
                                </span>
                            </td>
                            <td>
                                {{ rowData.fromDate | date : "dd/MM/yyyy" }} -
                                {{ rowData.toDate | date : "dd/MM/yyyy" }}
                            </td>
                            <td class="text-center">
                                <div class="flex gap-1 justify-content-center">
                                    <span
                                        class="mr-2 icon-tool"
                                        *ngIf="
                                            this.permisionHelper.hasPermissions(
                                                [
                                                    permissionConstant.ManageKPIEdit
                                                ]
                                            )
                                        "
                                    >
                                        <i
                                            style="display: block"
                                            class="pi pi-file-edit"
                                            (click)="
                                                openUpdateKpiVisible(rowData.id)
                                            "
                                        ></i>
                                    </span>

                                    <span
                                        class="icon-tool"
                                        *ngIf="
                                            this.permisionHelper.hasPermissions(
                                                [
                                                    permissionConstant.ManageKPIDelete
                                                ]
                                            )
                                        "
                                    >
                                        <i
                                            style="display: block"
                                            class="pi pi-trash"
                                        ></i>
                                    </span>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>

                <div
                    *ngIf="totalRecords === 0"
                    style="text-align: center; margin-top: 20px"
                >
                    <strong style="text-align: center; width: 100%"
                        >Không tìm thấy kết quả phù hợp</strong
                    >
                </div>

                <div class="paging-bot dg-fix">
                    <div class="paging-info">
                        <div [innerHTML]="currentPageReport"></div>
                    </div>
                    <p-paginator
                        [rows]="this.pageSize"
                        (onPageChange)="onPageChange($event)"
                        [totalRecords]="totalRecords > 0 ? totalRecords : 1"
                        [rowsPerPageOptions]="[10, 20, 30]"
                        [first]="(this.pageIndex - 1) * this.pageSize"
                    ></p-paginator>
                </div>
            </div>
        </div>
    </div>
</div>

<p-dialog
    header="Thêm bảng tổng hợp KPI"
    [modal]="true"
    [style]="{ width: '40vw' }"
    [(visible)]="createKpiVisible"
    (onHide)="closeCreateKpiVisible()"
>
    <form [formGroup]="detailForm">
        <div class="p-fluid">
            <div class="p-field">
                <label class="labelip" for="dateFormat"
                    >Thời gian<span class="red-asterisk">*</span></label
                >
                <p-calendar
                    formControlName="createTime"
                    [iconDisplay]="'input'"
                    [showIcon]="true"
                    [style]="{ width: '100%' }"
                    placeholder="Chọn tháng"
                    inputId="icondisplay"
                    [locale]="'vi'"
                    [view]="'month'"
                    [dateFormat]="'mm/yy'"
                    (onSelect)="onMonthSelect($event)"
                ></p-calendar>
                <div
                    *ngIf="
                        (detailForm.get('createTime')?.invalid &&
                            (detailForm.get('createTime')?.dirty ||
                                detailForm.get('createTime')?.touched)) ||
                        showErrorCreateTime
                    "
                >
                    <div
                        *ngIf="detailForm.get('createTime')?.errors?.['required']"
                        class="error-message"
                    >
                        <small>Thời gian không được bỏ trống</small>
                    </div>
                </div>
            </div>

            <div class="p-field">
                <label class="labelip" for="treeData"
                    >Đơn vị <span class="red-asterisk">*</span></label
                >
                <p-treeSelect
                    [options]="treeData"
                    formControlName="organizationId"
                    [placeholder]="'Chọn đơn vị'"
                    [showClear]="true"
                    [style]="{ width: '100%' }"
                    [filter]="true"
                    filterPlaceholder="Tìm kiếm"
                ></p-treeSelect>
                <div
                    *ngIf="
                        (detailForm.get('organizationId')?.invalid &&
                            (detailForm.get('organizationId')?.dirty ||
                                detailForm.get('organizationId')?.touched)) ||
                        showErrorOrganizationId
                    "
                >
                    <div
                        *ngIf="detailForm.get('organizationId')?.errors?.['required']"
                        class="error-message"
                    >
                        <small>Đơn vị không được bỏ trống</small>
                    </div>
                </div>
            </div>

            <div class="p-field mt-3">
                <label class="labelip" for="kpiTablePositions"
                    >Vị trí <span class="red-asterisk">*</span></label
                >
                <p-multiSelect
                    class="custom-multiselect"
                    [options]="staffPosition"
                    formControlName="kpiTablePositions"
                    placeholder="Chọn vị trí"
                    optionLabel="name"
                    display="chip"
                    [showClear]="true"
                    [style]="{ width: '100%' }"
                >
                </p-multiSelect>
                <div
                    *ngIf="
                        (detailForm.get('kpiTablePositions')?.invalid &&
                            (detailForm.get('kpiTablePositions')?.dirty ||
                                detailForm.get('kpiTablePositions')
                                    ?.touched)) ||
                        showErrorStaffPositionId
                    "
                >
                    <div
                        *ngIf="detailForm.get('kpiTablePositions')?.errors?.['required']"
                        class="error-message"
                    >
                        Vị trí không được bỏ trống
                    </div>
                </div>
            </div>

            <div class="p-field mt-3">
                <label class="labelip" for="value"
                    >Tên bảng tổng hợp KPI
                    <span class="red-asterisk">*</span></label
                >
                <input
                    pInputText
                    type="text"
                    formControlName="nameKpiTable"
                    placeholder="Nhập tên bảng tổng hợp KPI"
                />
                <div
                    *ngIf="
                        (detailForm.get('nameKpiTable')?.invalid &&
                            (detailForm.get('nameKpiTable')?.dirty ||
                                detailForm.get('nameKpiTable')?.touched)) ||
                        showErrorNameKpiTable
                    "
                >
                    <div
                        *ngIf="detailForm.get('nameKpiTable')?.errors?.['required']"
                        class="error-message"
                    >
                        Tên bảng tổng hợp KPI không được bỏ trống
                    </div>
                </div>
            </div>
        </div>
    </form>
    <!-- Footer -->
    <ng-template pTemplate="footer">
        <div
            class="footer-buttons justify-content-end flex gap-2"
            style="text-align: right"
        >
            <p-button
                label="Hủy"
                [outlined]="true"
                severity="secondary"
                (click)="closeCreateKpiVisible()"
            ></p-button>
            <button
                pButton
                type="button"
                label="Lưu"
                severity="danger"
                (click)="addKpi()"
            ></button>
        </div>
    </ng-template>
</p-dialog>

<p-dialog
    header="Cập nhật bảng tổng hợp KPI"
    [modal]="true"
    [style]="{ width: '40vw' }"
    [(visible)]="updateKpiVisible"
    (onHide)="closeUpdateKpiVisible()"
>
    <form [formGroup]="detailUpdateForm">
        <div class="p-fluid">
            <div class="p-field">
                <label class="labelip" for="dateFormat"
                    >Thời gian<span class="red-asterisk">*</span></label
                >
                <p-calendar
                    formControlName="createTime"
                    [iconDisplay]="'input'"
                    [showIcon]="true"
                    [style]="{ width: '100%' }"
                    placeholder="Chọn tháng"
                    inputId="icondisplay"
                    [locale]="'vi'"
                    [view]="'month'"
                    [dateFormat]="'mm/yy'"
                    (onSelect)="onMonthSelect($event)"
                    [ngClass]="{ 'disabled-class': isDisabled }"
                ></p-calendar>
                <div
                    *ngIf="
                        (detailForm.get('createTime')?.invalid &&
                            (detailForm.get('createTime')?.dirty ||
                                detailForm.get('createTime')?.touched)) ||
                        showErrorCreateTime
                    "
                >
                    <div
                        *ngIf="detailForm.get('createTime')?.errors?.['required']"
                        class="error-message"
                    >
                        <small>Thời gian không được bỏ trống</small>
                    </div>
                </div>
            </div>
            <div class="p-field">
                <label class="labelip" for="treeData"
                    >Đơn vị <span class="red-asterisk">*</span></label
                >
                <p-treeSelect
                    [options]="treeData"
                    formControlName="organizationId"
                    [placeholder]="'Chọn đơn vị'"
                    [showClear]="true"
                    [style]="{ width: '100%' }"
                    [filter]="true"
                    filterPlaceholder="Tìm kiếm"
                    [ngClass]="{ 'disabled-class': isDisabled }"
                ></p-treeSelect>
                <div
                    *ngIf="
                        (detailUpdateForm.get('organizationId')?.invalid &&
                            (detailUpdateForm.get('organizationId')?.dirty ||
                                detailUpdateForm.get('organizationId')
                                    ?.touched)) ||
                        showErrorOrganizationId
                    "
                >
                    <div
                        *ngIf="detailUpdateForm.get('organizationId')?.errors?.['required']"
                        class="error-message"
                    >
                        <small>Đơn vị không được bỏ trống</small>
                    </div>
                </div>
            </div>

            <div class="p-field mt-3">
                <label class="labelip" for="kpiTablePositions"
                    >Vị trí <span class="red-asterisk">*</span></label
                >
                <p-multiSelect
                    class="custom-multiselect"
                    [options]="staffPosition"
                    formControlName="kpiTablePositions"
                    placeholder="Chọn vị trí"
                    optionLabel="name"
                    display="chip"
                    [showClear]="true"
                    [style]="{ width: '100%' }"
                    [ngClass]="{ 'disabled-class': isDisabled }"
                >
                </p-multiSelect>
                <div
                    *ngIf="
                        (detailUpdateForm.get('kpiTablePositions')?.invalid &&
                            (detailUpdateForm.get('kpiTablePositions')?.dirty ||
                                detailUpdateForm.get('kpiTablePositions')
                                    ?.touched)) ||
                        showErrorStaffPositionId
                    "
                >
                    <div
                        *ngIf="detailUpdateForm.get('kpiTablePositions')?.errors?.['required']"
                        class="error-message"
                    >
                        Vị trí không được bỏ trống
                    </div>
                </div>
            </div>

            <div class="p-field mt-3">
                <label class="labelip" for="value"
                    >Tên bảng tổng hợp KPI
                    <span class="red-asterisk">*</span></label
                >
                <input
                    pInputText
                    type="text"
                    formControlName="nameKpiTable"
                    placeholder="Nhập tên bảng tổng hợp KPI"
                />
                <div
                    *ngIf="
                        (detailUpdateForm.get('nameKpiTable')?.invalid &&
                            (detailUpdateForm.get('nameKpiTable')?.dirty ||
                                detailUpdateForm.get('nameKpiTable')
                                    ?.touched)) ||
                        showErrorNameKpiTable
                    "
                >
                    <div
                        *ngIf="detailUpdateForm.get('nameKpiTable')?.errors?.['required']"
                        class="error-message"
                    >
                        Tên bảng tổng hợp KPI không được bỏ trống
                    </div>
                </div>
            </div>
        </div>
    </form>
    <!-- Footer -->
    <ng-template pTemplate="footer">
        <div
            class="footer-buttons justify-content-end flex gap-2"
            style="text-align: right"
        >
            <p-button
                label="Hủy"
                [outlined]="true"
                severity="secondary"
                (click)="closeUpdateKpiVisible()"
            ></p-button>
            <button
                pButton
                type="button"
                label="Lưu"
                severity="danger"
                (click)="updateKpi()"
            ></button>
        </div>
    </ng-template>
</p-dialog>
