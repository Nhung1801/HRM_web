<!-- <p-confirmDialog [style]="{ width: '50vw' }"></p-confirmDialog> -->

<div class="grid">
    <div class="col-12">
        <p-toolbar styleClass="mb-2">
            <div class="">
                <strong class="font-size-16">Bảng lương chi tiết</strong>
                <p-breadcrumb
                    [model]="items"
                    [home]="{ icon: 'pi pi-home' }"
                ></p-breadcrumb>
            </div>
            <!-- <ng-template pTemplate="right">
                <div class="flex gap-2">
                    <button
                        [routerLink]="['/shift/create']"
                        pButton
                        pRipple
                        icon="pi pi-plus"
                        label="Thêm mới ca"
                        (click)="show()"
                    ></button>
                    <p-button
                        label="Xóa"
                        [disabled]="
                            this.selectedShift.length > 0 ? false : true
                        "
                        (click)="handleOnDeleteMultiple($event)"
                        severity="danger"
                    ></p-button>
                </div>
            </ng-template> -->
        </p-toolbar>
        <div class="card">
            <div class="mb-3">
                <div class="flex gap-3 justify-content-between">
                    <div class="flex gap-3">
                        <div class="flex align-items-center gap-3">
                            <i
                                class="pi pi-arrow-left d-block"
                                (click)="goBack()"
                            ></i>
                            <span class="salary-detail-name">
                                {{ payrollName }}
                            </span>
                            <i
                                class="pi pi-file-edit d-block"
                                (click)="onEditName()"
                            ></i>
                        </div>
                        <p-button
                            label="{{ payrollStatusLabel }}"
                            [outlined]="true"
                            severity="secondary"
                        ></p-button>
                        <p-button
                            [label]="isPayrollLocked ? 'Đã khóa' : 'Chưa khóa'"
                            [icon]="isPayrollLocked ? 'pi pi-lock' : 'pi pi-unlock'"
                            (click)="clockWorkDialog = true"
                            [outlined]="true"
                            severity="secondary"
                        ></p-button>
                    </div>
                    <div class="flex gap-3">
                        <p-button
                            label="Cập nhật phiếu lương"
                            [outlined]="true"
                            severity="secondary"
                            (click)="reCalculatePayroll()"
                            [disabled]="isPayrollLocked"
                        ></p-button>
                        <p-button
                            label="Gửi xác nhận"
                            icon="pi pi-send"
                            (click)="workConfirmDialog = true"
                            [outlined]="true"
                            severity="secondary"
                        ></p-button>
                        <p-button
                            label=""
                            icon="pi pi-ellipsis-h"
                            [outlined]="true"
                            severity="secondary"
                        ></p-button>
                        <p-button
                            label=""
                            icon="pi pi-comment"
                            [outlined]="true"
                            (click)="responseEmployeeVisiable = true"
                            severity="secondary"
                        ></p-button>
                    </div>
                </div>
            </div>
            <div class="flex justify-content-between">
                <div class="flex gap-3">
                    <div class="flex flex-column">
                        <span class="block mt-2 md:mt-0 p-input-icon-left">
                            <i class="pi pi-search"></i>
                            <input
                                pInputText
                                type="text"
                                placeholder="Tìm theo tên ca"
                                [(ngModel)]="queryParameters.name"
                                style="width: 300px"
                            />
                        </span>
                    </div>
                    <div class="flex flex-column">
                        <button
                            [routerLink]="['/shift/create']"
                            pButton
                            pRipple
                            (click)="handleSearchPayrollDetails()"
                            label="Lọc"
                        ></button>
                    </div>
                </div>
                <div class="flex gap-2">
                    <div class="flex flex-column">
                        <p-treeSelect
                            [attr.aria-hidden]="null"
                            class="md:w-20rem w-full"
                            containerStyleClass="w-full"
                            [(ngModel)]="queryParameters.organization"
                            [options]="organizations"
                            placeholder="Chọn đơn vị"
                            [showClear]="true"
                        />
                    </div>
                    <p-button
                        label=""
                        icon="pi pi-filter"
                        [outlined]="true"
                        severity="secondary"
                    ></p-button>
                    <p-button
                        label=""
                        icon="pi pi-cog"
                        [outlined]="true"
                        severity="secondary"
                    ></p-button>
                </div>
            </div>
            <div class="table-section" style="margin-top: 20px">
                <div class="table-wrapper">
                    <p-table
                        responsiveLayout="scroll"
                        styleClass="p-datatable-striped"
                        [rowHover]="true"
                        [paginator]="false"
                        [value]="payrollDetails"
                        [(selection)]="selectedPayroll"
                        (onSelectionChange)="onSelectionChange($event)"
                        dataKey="id"
                        [tableStyle]="{ 'min-width': '300rem' }"
                        [scrollable]="true"
                        scrollHeight="400px"
                    >
                        <ng-template pTemplate="header">
                            <tr>
                                <th class="sticky-column" style="width: 5px">
                                    <p-tableHeaderCheckbox
                                        [(selection)]="selectedPayroll"
                                    ></p-tableHeaderCheckbox>
                                </th>
                                <th class="sticky-column" style="width: 8px">
                                    STT
                                </th>
                                <th class="sticky-column">Mã nhân viên</th>
                                <th class="sticky-column">Họ và tên</th>
                                <th>Bộ phận</th>
                                <th>Hợp đồng</th>
                                <th class="text-center">Lương cứng</th>
                                <th class="text-center">Ngày công chuẩn</th>
                                <th class="text-center">Ngày thực tế</th>
                                <th class="text-center">
                                    Lương cứng thực nhận
                                </th>
                                <th class="text-center">KPI thực nhận</th>
                                <th class="text-center">% KPI đạt</th>
                                <th class="text-center">Lương KPI</th>
                                <th class="text-center">Thưởng</th>
                                <th class="text-center">BHXH</th>
                                <th class="text-center">Quỹ công đoàn</th>
                                <th class="text-center">Tỉ lệ hưởng lương</th>
                                <th class="text-center">Tổng lương</th>
                                <th class="text-center">
                                    Tổng lương thực nhận
                                </th>
                                <th class="text-center">Trạng thái</th>
                                <th class="text-center">Hành động</th>
                            </tr>
                        </ng-template>
                        <ng-template
                            pTemplate="body"
                            let-rowData
                            let-i="rowIndex"
                        >
                            <tr>
                                <td class="sticky-column">
                                    <p-tableCheckbox
                                        [(selection)]="selectedPayroll"
                                        [value]="rowData"
                                    ></p-tableCheckbox>
                                </td>
                                <td class="sticky-column">{{ i + 1 }}</td>
                                <td class="sticky-column">
                                    {{ rowData.employeeCode }}
                                </td>
                                <td class="sticky-column">
                                    {{ rowData.fullName }}
                                </td>
                                <td>{{ rowData.organizationName }}</td>
                                <td>
                                    {{ rowData.contractTypeName }}
                                </td>
                                <td class="text-center">
                                    {{ rowData.baseSalary | number : "1.0-0" }}
                                </td>
                                <td class="text-center">
                                    {{ rowData.standardWorkDays }}
                                </td>
                                <td class="text-center">
                                    {{ rowData.actualWorkDays }}
                                </td>
                                <td class="text-center">
                                    {{
                                        rowData.receivedSalary
                                            | number : "1.0-0"
                                    }}
                                </td>
                                <td class="text-center">
                                    {{ rowData.kpi | number : "1.0-0" }}
                                </td>
                                <td class="text-center">
                                    {{ rowData.kpiPercentage }}
                                </td>
                                <td class="text-center">
                                    {{ rowData.kpiSalary | number : "1.0-0" }}
                                </td>
                                <td class="text-center">
                                    {{ rowData.bonus | number : "1.0-0" }}
                                </td>
                                <td class="text-center">
                                    {{
                                        rowData.socialInsurance
                                            | number : "1.0-0"
                                    }}
                                </td>
                                <td class="text-center">
                                    {{ rowData.unionFee | number : "1.0-0" }}
                                </td>
                                <td class="text-center">
                                    {{ rowData.salaryRate }}
                                </td>
                                <td class="text-center">
                                    {{ rowData.totalSalary | number : "1.0-0" }}
                                </td>
                                <td class="text-center">
                                    {{
                                        rowData.totalReceivedSalary
                                            | number : "1.0-0"
                                    }}
                                </td>
                                <td class="text-center">
                                    <span>{{ rowData.statusName }}</span>
                                </td>
                                <td>
                                    <div
                                        class="flex gap-1 justify-content-center"
                                    >
                                        <span class="mr-2 icon-tool"
                                            ><i
                                                style="display: block"
                                                class="pi pi-file-edit"
                                            ></i
                                        ></span>
                                        <span class="icon-tool"
                                            ><i
                                                style="display: block"
                                                class="pi pi-trash"
                                            ></i
                                        ></span>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>
                    </p-table>
                </div>

                <div
                    class="flex align-items-center mt-3"
                    style="justify-content: space-between"
                >
                    <p>
                        <span style="font-weight: 500">{{
                            1 + (paging.pageIndex - 1) * paging.pageSize
                        }}</span>
                        -
                        <span style="font-weight: 500">{{
                            1 +
                                (paging.pageIndex - 1) * paging.pageSize +
                                (paging.pageSize - 1)
                        }}</span>
                        trong
                        <span style="font-weight: 500">{{
                            paging.totalRecords
                        }}</span>
                        bản ghi
                    </p>
                    <div *ngIf="payrollDetails?.length > 0">
                        <p-paginator
                            class="custum-paging"
                            (onPageChange)="onPageChange($event)"
                            [first]="(paging.pageIndex - 1) * paging.pageSize"
                            [rows]="paging.pageSize"
                            [totalRecords]="paging.totalRecords"
                            [rowsPerPageOptions]="config.pageSizeOptions"
                        />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thông báo -->
<p-dialog
    header="Thông báo"
    [modal]="true"
    [(visible)]="clockWorkDialog"
    [style]="{ width: '40vw' }"
>
    <div class="card p-0" style="position: sticky; top: 97px">
        <p>
            {{
                isPayrollLocked
                    ? "Thao tác này sẽ giúp bạn mở khóa bảng lương để có thể cập nhật dữ liệu. Bạn có chắc chắn muốn thực hiện không?"
                    : "Thao tác này sẽ giúp bạn khóa bảng lại để không thể sửa, xóa dữ liệu. Bạn có chắc chắn muốn thực hiện không?"
            }}
        </p>
    </div>
    <div
        class="footer-buttons justify-content-end flex gap-2"
        style="text-align: right"
    >
        <p-button
            label="Hủy"
            (click)="clockWorkDialog = false"
            [outlined]="true"
            severity="secondary"
        ></p-button>
        <button
            pButton
            type="button"
            [label]="isPayrollLocked ? 'Mở khóa' : 'Khóa'"
            (click)="togglePayrollLock()"
            severity="danger"
        ></button>
    </div>
</p-dialog>

<!-- Gửi xác nhận bảng lương -->
<p-dialog
    header="Gửi xác nhận bảng lương"
    [modal]="true"
    [(visible)]="workConfirmDialog"
    [style]="{ width: '30vw' }"
>
    <div class="card p-0" style="position: sticky; top: 97px">
        <div class="field flex gap-5 align-items-center">
            <label class="mb-0">Thời hạn nhận phản hồi</label>
            <p-calendar
                [(ngModel)]="workConfirmTime"
                [iconDisplay]="'input'"
                [showIcon]="true"
                placeholder="dd/mm/yyyy"
                inputId="icondisplay"
                appendTo="body"
            ></p-calendar>
        </div>
    </div>
    <div
        class="footer-buttons justify-content-end flex gap-2"
        style="text-align: right"
    >
        <p-button
            label="Hủy"
            (click)="workConfirmDialog = false"
            [outlined]="true"
            severity="secondary"
        ></p-button>
        <button
            pButton
            type="button"
            label="Chắc chắn"
            (click)="handleSendPayrollDetailConfirm()"
            severity="danger"
        ></button>
    </div>
</p-dialog>

<p-dialog
    header="Danh sách phản hồi nhân viên"
    [modal]="true"
    [(visible)]="responseEmployeeVisiable"
    [style]="{ width: '30vw' }"
>
    324324324324
</p-dialog>
<!-- Dialog PrimeNG -->
<p-dialog
    [(visible)]="displayEditDialog"
    header="Chỉnh sửa tên bảng lương"
    [modal]="true"
>
    <div class="p-fluid">
        <label for="payrollName">Tên bảng lương</label>
        <input
            id="payrollName"
            type="text"
            [(ngModel)]="payrollName"
            pInputText
        />
    </div>
    <div class="p-dialog-footer">
        <button
            (click)="savePayroll()"
            pButton
            label="Lưu"
            class="p-button-label"
        ></button>
        <button
            (click)="displayEditDialog = false"
            pButton
            label="Hủy"
            class="p-button-secondary ml-2"
        ></button>
    </div>
</p-dialog>
<div *ngIf="isLoading" class="overlay">
    <p-progressSpinner></p-progressSpinner>
    <p class="loading-text">Đang tính toán bảng lương...</p>
</div>
