<div class="grid">
    <div class="col-12">
        <p-toolbar styleClass="mb-2">
            <div class="">
                <strong class="font-size-16">Thêm cơ cấu tổ chức</strong>
                <p-breadcrumb
                    [model]="items"
                    [home]="{ icon: 'pi pi-home' }"
                ></p-breadcrumb>
            </div>
            <ng-template pTemplate="right"></ng-template>
        </p-toolbar>
        <div class="card">
            <form [formGroup]="unitForm" (ngSubmit)="onSubmit()" novalidate>
                <div class="grid p-fluid p-3">
                    <div class="col-6">
                        <!-- Mã đơn vị -->
                        <div class="row my-3">
                            <div class="field mb-0">
                                <label
                                    style="font-weight: 600; color: #000"
                                    htmlFor="name1"
                                    >Mã đơn vị<span class="red-asterisk"
                                        >*</span
                                    ></label
                                >
                                <div class="">
                                    <input
                                        pInputText
                                        type="text"
                                        spellcheck="false"
                                        placeholder="Nhập mã đơn vị"
                                        formControlName="organizationCode"
                                    />
                                    <div
                                        *ngIf="
                                            unitForm?.get('organizationCode')
                                                ?.invalid &&
                                            unitForm.get('organizationCode')
                                                ?.touched
                                        "
                                        style="color: red; font-size: 12px"
                                    >
                                        <div
                                            *ngIf="
                                                unitForm?.get(
                                                    'organizationCode'
                                                )?.invalid &&
                                                unitForm.get('organizationCode')
                                                    ?.touched
                                            "
                                            style="color: red; font-size: 12px"
                                        >
                                            <span
                                                *ngIf="unitForm.get('organizationCode')?.errors?.['required']"
                                                >Vui lòng nhập mã đơn vị</span
                                            >
                                            <span
                                                *ngIf="unitForm.get('organizationCode')?.errors?.['whitespace']"
                                                >Mã đơn vị không được chỉ chứa
                                                khoảng trắng</span
                                            >
                                            <span
                                                *ngIf="unitForm.get('organizationCode')?.errors?.['duplicate']"
                                                >Mã đơn vị đã tồn tại, vui lòng
                                                nhập mã khác</span
                                            >
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Tên đơn vị -->
                        <div class="row my-3">
                            <div class="field mb-0">
                                <label
                                    style="font-weight: 600; color: #000"
                                    htmlFor="name1"
                                    >Tên đơn vị<span class="red-asterisk"
                                        >*</span
                                    ></label
                                >
                                <div class="">
                                    <input
                                        pInputText
                                        type="text"
                                        spellcheck="false"
                                        placeholder="Nhập tên đơn vị"
                                        formControlName="organizationName"
                                    />
                                    <div
                                        *ngIf="
                                            unitForm?.get('organizationName')
                                                ?.invalid &&
                                            unitForm.get('organizationName')
                                                ?.touched
                                        "
                                        style="color: red; font-size: 12px"
                                    >
                                        <span
                                            *ngIf="unitForm.get('organizationName')?.errors?.['required']"
                                            >Vui lòng nhập tên đơn vị,</span
                                        >
                                        <span
                                            *ngIf="unitForm.get('organizationName')?.errors?.['whitespace']"
                                            >Tên đơn vị không được chỉ chứa
                                            khoảng trắng</span
                                        >
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Tên viết tắt -->
                        <div class="row my-3">
                            <div class="field mb-0">
                                <label
                                    style="font-weight: 600; color: #000"
                                    htmlFor="name1"
                                    >Tên viết tắt
                                </label>
                                <input
                                    pInputText
                                    type="text"
                                    spellcheck="false"
                                    placeholder="Nhập tên viết tắt"
                                    formControlName="abbreviation"
                                />
                            </div>
                        </div>
                        <!-- Thuộc đơn vị -->
                        <div class="row my-3">
                            <div class="field mb-0">
                                <label
                                    style="font-weight: 600; color: #000"
                                    for="parentUnit"
                                >
                                    Thuộc đơn vị<span class="red-asterisk"
                                        >*</span
                                    >
                                </label>
                                <div
                                    style="width: 400px"
                                    (focusout)="
                                        handleTreeSelectFocusOut($event)
                                    "
                                >
                                    <p-treeSelect
                                        class="w-full custom-tree-select"
                                        [formControl]="
                                            unitForm.get('organizatioParentId')
                                        "
                                        [options]="nodes"
                                        [metaKeySelection]="false"
                                        placeholder="Chọn đơn vị"
                                        [showClear]="true"
                                        (onClear)="validateParentUnit()"
                                        (onChange)="onParentUnitChange($event)"
                                        [style]="{
                                            maxHeight: '300px',
                                            overflow: 'auto'
                                        }"
                                    >
                                    </p-treeSelect>
                                    <!-- (onChange)="validateParentUnit()" -->

                                    <div
                                        *ngIf="isParentUnitInvalid"
                                        style="color: red; font-size: 12px"
                                    >
                                        <span>Vui lòng chọn đơn vị</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!--  Cấp tổ chức -->
                        <div class="row my-3">
                            <div class="field mb-0">
                                <label
                                    style="font-weight: 600; color: #000"
                                    htmlFor="name1"
                                    >Cấp tổ chức<span class="red-asterisk"
                                        >*</span
                                    ></label
                                >
                                <div class="" style="display: inline-block">
                                    <div
                                        (focusout)="handleLevelFocusOut($event)"
                                    >
                                        <div class="d-flex">

                                            <p-dropdown
                                                class="level-list"
                                                [options]="listOrganiType"
                                                [formControl]="
                                                    unitForm.get(
                                                        'organizationTypeId'
                                                    )
                                                "
                                                optionLabel="organizationTypeName"
                                                placeholder="Chọn cấp tổ chức"
                                                [showClear]="true"
                                                [style]="{ width: '358px' }"
                                                [(ngModel)]="selectedOrganiType"
                                            ></p-dropdown>
                                            <span
                                                style="
                                                    margin: auto 0;
                                                    padding: 10px;
                                                    border: 1px solid #ccc;
                                                    margin-left: 5px;
                                                    border-radius: 5px;
                                                "
                                            >
                                                <svg
                                                    (click)="showDialog()"
                                                    xmlns="http://www.w3.org/2000/svg"
                                                    width="16"
                                                    height="16"
                                                    fill="currentColor"
                                                    class="bi bi-three-dots-vertical cursor-pointer"
                                                    viewBox="0 0 16 16"
                                                >
                                                    <path
                                                        d="M9.5 13a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0m0-5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0"
                                                    />
                                                </svg>
                                                <p-dialog
                                                    header="Cấp tổ chức"
                                                    [modal]="true"
                                                    [(visible)]="dialogVisible"
                                                    [style]="{ width: '500px' }"
                                                    (onHide)="onDialogClose()"
                                                >
                                                <div class="scrollable-container" style="max-height: 500px; overflow-y: auto;  padding-bottom: 150px;">
                                                    <div class="flex align-items-center gap-3 mb-3 mt-3 pb-2" style="border-bottom: 1px solid #ccc;" *ngFor="let pr of listOrganiType">
                                                        <label class="font-semibold">
                                                            <input
                                                                type="radio"
                                                                name="checked"
                                                                style="width: 20px; height: 20px; border-radius: 50%; margin-right: 8px;"
                                                                class="custom-checkbox"
                                                                [checked]="selectedOrganiType?.id === pr.id"
                                                                (change)="onRadioChange(pr)"
                                                            />
                                                        </label>
                                                        <span>{{ pr.organizationTypeName }}</span>
                                                    </div>
                                                </div>
                                                
                                                <div class="position-fixed footer" style="background-color: #fff; width: 100%; bottom: 0; left: 0; padding: 12px 16px">
                                                    <div class="text-left mt-3">
                                                        <input
                                                        pInputText
                                                        type="text"
                                                        placeholder="Thêm cấp tổ chức"
                                                        style="width: 460px !important; margin-bottom: 1px;"
                                                        [formControl]="organizationTypeControl"
                                                        (keyup.enter)="onSubmitOrganiStructType()"
                                                    />
                                                        <p (click)="onSubmitOrganiStructType()" style="padding-top: 5px; color: #3d75de; cursor: pointer;">+ Thêm mới</p>
                                                    </div>
                                                    <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px;">
                                                        <span 
                                                            (click)="onDialogClose()" 
                                                            style="padding: 10px 16px; background-color: #fff; color: #000; border-radius: 6px; border: 1px solid #ccc; cursor: pointer;"
                                                        >
                                                            Hủy
                                                        </span>
                                                        <p-button (click)="onSaveOrganiType()" label="Lưu"></p-button>
                                                    </div>
                                                </div>
                                                </p-dialog>
                                            </span>
                                        </div>

                                    </div>
                                    <div
                                        *ngIf="isLevelUnitInvalid"
                                        style="color: red; font-size: 12px"
                                    >
                                        <span>Vui lòng chọn tổ chức</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Số thứ tụ -->
                        <div class="row my-3">
                            <div class="field mb-0">
                                <label
                                    style="font-weight: 600; color: #000"
                                    htmlFor="name1"
                                    >Số thứ tự
                                </label>
                                <input
                                    pInputText
                                    type="number"
                                    spellcheck="false"
                                    placeholder="Số thứ tự"
                                    formControlName="rank"
                                    min="1"
                                    max="3"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="col-6">
                        <!-- Trưởng đơn vị -->
                        <div class="row my-3">
                            <div class="field mb-0">
                                <label
                                    style="font-weight: 600; color: #000"
                                    for="name1"
                                    >Trưởng ĐV</label
                                >
                                <p-multiSelect
                                    [options]="listEmployee"
                                    formControlName="organizationLeaders"
                                    optionLabel="name"
                                    placeholder="Chọn trưởng phòng ban"
                                    [showClear]="true"
                                    display="chip"
                                    [style]="{
                                        width: '400px',
                                        height: '45px',
                                        scrollY: 'auto'
                                    }"
                                >
                                </p-multiSelect>

                                <!-- Hiển thị danh sách đã chọn -->
                                <div
                                    *ngIf="selectDepartmentHeads?.length"
                                    style="margin-top: 10px"
                                >
                                    <span
                                        *ngFor="
                                            let head of selectedDepartmentHeads;
                                            let i = index
                                        "
                                        class="selected-head"
                                        style="
                                            display: inline-block;
                                            margin-right: 10px;
                                            padding: 5px 10px;
                                            background-color: #f0f0f0;
                                            border-radius: 16px;
                                            position: relative;
                                        "
                                    >
                                        {{ head.name }}
                                        <button
                                            (click)="removeSelectedHead(i)"
                                            style="
                                                background: none;
                                                border: none;
                                                color: red;
                                                font-weight: bold;
                                                margin-left: 5px;
                                                cursor: pointer;
                                            "
                                        >
                                            x
                                        </button>
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!--  Chức năng và nhiệm vụ -->
                        <div class="row my-3">
                            <div class="field mb-0">
                                <label
                                    style="font-weight: 600; color: #000"
                                    htmlFor="name1"
                                    >Chức năng , nhiệm vụ
                                </label>
                                <input
                                    pInputText
                                    type="text"
                                    spellcheck="false"
                                    placeholder="Nhập chức năng và nhiệm vụ"
                                    formControlName="organizationDescription"
                                />
                            </div>
                        </div>
                        <!--  Số DK kinh doanh  -->
                        <div class="row my-3">
                            <div class="field mb-0">
                                <label
                                    style="font-weight: 600; color: #000"
                                    htmlFor="name1"
                                    >Số DK kinh doanh
                                </label>
                                <input
                                    pInputText
                                    type="text"
                                    spellcheck="false"
                                    placeholder="Nhập số DK kinh doanh"
                                    formControlName="businessRegistrationCode"
                                />
                            </div>
                        </div>
                        <!-- Ngày cấp -->
                        <div class="row my-3">
                            <div class="field mb-0">
                                <label
                                    style="font-weight: 600; color: #000"
                                    htmlFor="name1"
                                    >Ngày cấp
                                </label>
                                <p-calendar
                                    formControlName="businessRegistrationDate"
                                    [style]="{ width: '400px' }"
                                    placeholder="dd/mm/yy "
                                    dateFormat="dd/mm/yy"
                                    [showIcon]="true"
                                    name="date"
                                />
                            </div>
                        </div>
                        <!-- Nơi cấp -->
                        <div class="row my-3">
                            <div class="field mb-0">
                                <label
                                    style="font-weight: 600; color: #000"
                                    htmlFor="name1"
                                    >Nơi cấp
                                </label>
                                <input
                                    pInputText
                                    type="text"
                                    spellcheck="false"
                                    placeholder="Nhập nơi cấp"
                                    formControlName="issuingAuthority"
                                />
                            </div>
                        </div>
                        <!--  Địa chỉ -->
                        <div class="row my-3">
                            <div class="field mb-0">
                                <label
                                    style="font-weight: 600; color: #000"
                                    htmlFor="name1"
                                    >Địa chỉ
                                </label>
                                <input
                                    pInputText
                                    type="text"
                                    spellcheck="false"
                                    placeholder="Nhập địa chỉ"
                                    formControlName="organizationAddress"
                                />
                            </div>
                        </div>
                    </div>
                </div>
                <div
                    class="p-mt-3"
                    style="display: flex; justify-content: end; padding: 10px"
                >
                    <button
                        [routerLink]="['/organizational-structure/show']"
                        pButton
                        type="button"
                        label="Hủy"
                        class="p-button-secondary mr-3 cursor-pointer"
                        style="background-color: #ccc; border: none"
                    ></button>
                    <button
                        pButton
                        type="submit"
                        label="Thêm mới"
                        [disabled]="unitForm.invalid"
                        class="btn btn-primary cursor-pointer"
                        style="background-color: #2a2986;"
                    ></button>
                </div>
            </form>
        </div>
    </div>
</div>
