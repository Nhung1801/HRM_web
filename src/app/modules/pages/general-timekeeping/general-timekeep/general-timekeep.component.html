<main id="main" class="main">
    <div class="pagetitle">
        <div>
            <strong class="font-size-16">Bảng chấm công tổng hợp</strong>
            <p-breadcrumb [model]="items"> </p-breadcrumb>
        </div>

        <div
            class="btn-add-wrapper"
            *ngIf="
                this.permisionHelper.hasPermissions([
                    permissionConstant.ManageGeneralTimekeepingCreate
                ])
            "
        >
            <button
                pButton
                pRipple
                label="Thêm mới"
                icon="pi pi-plus"
                style="height: 40px; width: 130px; border-radius: 10px"
                (click)="showDialogAdd()"
            ></button>
        </div>
    </div>
    <div class="toast-container">
        <p-messages
            [(value)]="messages"
            [enableService]="false"
            [closable]="false"
        ></p-messages>
    </div>
    <!-- End Page Title -->
    <section class="section k-list-table">
        <div class="row">
            <div class="col-lg-12">
                <div class="card-body">
                    <div class="row">
                        <div class="col-lg-3 mt-3">
                            <p-autoComplete
                                [style]="{ height: '43px', width: '100%' }"
                                [(ngModel)]="selectedEmployee"
                                [suggestions]="filteredName"
                                (completeMethod)="searchName($event)"
                                [field]="'displayName'"
                                [showClear]="true"
                                placeholder="Tìm kiếm tên bảng chấm công"
                            >
                            </p-autoComplete>
                        </div>
                        <div class="col-lg-3 mt-3">
                            <div class="filter-container">
                                <button (click)="prevMonth()">
                                    <i class="pi pi-arrow-left"></i>
                                </button>
                                <span>{{
                                    currentMonthYear.toLocaleDateString(
                                        "vi-VN",
                                        { month: "long", year: "numeric" }
                                    )
                                }}</span>
                                <button (click)="nextMonth()">
                                    <i class="pi pi-arrow-right"></i>
                                </button>
                            </div>
                        </div>

                        <div class="col-lg-3 mt-3">
                            <p-treeSelect
                                [options]="treeData"
                                [(ngModel)]="selectedNode"
                                [placeholder]="'Tất cả đơn vị'"
                                [showClear]="true"
                                [style]="{ width: '100%' }"
                            ></p-treeSelect>
                        </div>

                        <div class="col-lg-1 mt-3">
                            <button
                                style="height: 43px"
                                pButton
                                pRipple
                                label="Lọc"
                                class="buttonfilter"
                                (click)="getPagingSummaryTimesheet()"
                            ></button>
                        </div>
                    </div>
                    <div class="card mt-3">
                        <p-table
                            [value]="summaryTimesheet"
                            [paginator]="true"
                            [rows]="pageSize"
                            [totalRecords]="totalRecords"
                            [paginator]="false"
                            (onPage)="onPageChange($event)"
                            styleClass="p-datatable-striped"
                        >
                            <ng-template pTemplate="header">
                                <tr>
                                    <th style="width: 1%">
                                        <p-checkbox
                                            [binary]="true"
                                            inputId="binary"
                                        ></p-checkbox>
                                    </th>
                                    <th style="width: 12%">
                                        Tên bảng châm công
                                    </th>
                                    <th style="width: 9%">Thời gian</th>
                                    <th style="width: 5%">Chấm công</th>
                                    <th style="width: 10%">Đơn vị áp dụng</th>
                                    <th style="width: 12%">Vị trí</th>
                                    <th style="width: 7%">Trạng thái</th>
                                    <th
                                        style="width: 4%"
                                        *ngIf="
                                            this.permisionHelper.hasPermissions(
                                                [
                                                    permissionConstant.ManageGeneralTimekeepingEdit
                                                ]
                                            ) ||
                                            this.permisionHelper.hasPermissions(
                                                [
                                                    permissionConstant.ManageGeneralTimekeepingEdit
                                                ]
                                            )
                                        "
                                    >
                                        Thao tác
                                    </th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-detail>
                                <tr>
                                    <td>
                                        <p-checkbox
                                            [binary]="true"
                                            inputId="binary"
                                        ></p-checkbox>
                                    </td>
                                    <td>{{ detail.timekeepingSheetName }}</td>
                                    <td>
                                        {{
                                            getMinMaxDates(
                                                detail.summaryTimesheetNameDetailTimesheetNames
                                            )?.minDate | date : "dd/MM/yyyy"
                                        }}
                                        -
                                        {{
                                            getMinMaxDates(
                                                detail.summaryTimesheetNameDetailTimesheetNames
                                            )?.maxDate | date : "dd/MM/yyyy"
                                        }}
                                    </td>
                                    <td>
                                        {{
                                            detail.timekeepingMethod === 0
                                                ? "Theo giờ"
                                                : "Theo ngày"
                                        }}
                                    </td>
                                    <td>
                                        {{
                                            detail.organization
                                                ?.organizationName
                                        }}
                                    </td>
                                    <td>
                                        <span
                                            *ngIf="
                                                isAllPositionsMatch(
                                                    detail.positionNames
                                                )
                                            "
                                        >
                                            Tất cả vị trí
                                        </span>
                                        <span
                                            *ngIf="
                                                !isAllPositionsMatch(
                                                    detail.positionNames
                                                )
                                            "
                                        >
                                            <span
                                                *ngIf="
                                                    detail.positionNames
                                                        .length <= 100
                                                "
                                            >
                                                {{ detail.positionNames }}
                                            </span>
                                            <span
                                                *ngIf="
                                                    detail.positionNames
                                                        .length > 100
                                                "
                                            >
                                                <span
                                                    *ngIf="
                                                        !expandedRows[detail.id]
                                                    "
                                                >
                                                    {{
                                                        detail.positionNames
                                                            | slice : 0 : 100
                                                    }}...
                                                    <a
                                                        href="#"
                                                        (click)="
                                                            toggleRow(
                                                                detail.id,
                                                                $event
                                                            )
                                                        "
                                                        >Xem thêm</a
                                                    >
                                                </span>
                                                <span
                                                    *ngIf="
                                                        expandedRows[detail.id]
                                                    "
                                                >
                                                    {{ detail.positionNames }}
                                                    <a
                                                        href="#"
                                                        (click)="
                                                            toggleRow(
                                                                detail.id,
                                                                $event
                                                            )
                                                        "
                                                        >Ẩn bớt</a
                                                    >
                                                </span>
                                            </span>
                                        </span>
                                    </td>
                                    <td>
                                        <span
                                            class="status-span"
                                            [ngStyle]="{
                                                color: getsummaryTimesheetNameStatus(
                                                    detail.status
                                                ).color,
                                                'background-color':
                                                    getsummaryTimesheetNameStatus(
                                                        detail.status
                                                    ).bgColor
                                            }"
                                        >
                                            {{
                                                getsummaryTimesheetNameStatus(
                                                    detail.status
                                                ).text
                                            }}
                                        </span>
                                    </td>
                                    <td>
                                        <i
                                            *ngIf="
                                                this.permisionHelper.hasPermissions(
                                                    [
                                                        permissionConstant.ManageGeneralTimekeepingEdit
                                                    ]
                                                )
                                            "
                                            class="pi pi-eye"
                                            [routerLink]="[
                                                '/summary-timesheet',
                                                detail.id
                                            ]"
                                        ></i>
                                        <i
                                            *ngIf="
                                                this.permisionHelper.hasPermissions(
                                                    [
                                                        permissionConstant.ManageGeneralTimekeepingDelete
                                                    ]
                                                )
                                            "
                                            style="padding-left: 15px"
                                            class="pi pi-trash"
                                        ></i>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>

                        <div
                            *ngIf="totalRecords === 0"
                            style="text-align: center; margin-top: 20px"
                        >
                            <strong style="text-align: center; width: 100%"
                                >Không tìm thấy kết quả phù hợp</strong
                            >
                        </div>

                        <div class="paging-bot dg-fix">
                            <div class="paging-info">
                                <div [innerHTML]="currentPageReport"></div>
                            </div>
                            <p-paginator
                                [rows]="this.pageSize"
                                (onPageChange)="onPageChange($event)"
                                [totalRecords]="
                                    totalRecords > 0 ? totalRecords : 1
                                "
                                [rowsPerPageOptions]="[10, 20, 30]"
                                [first]="(this.pageIndex - 1) * this.pageSize"
                            ></p-paginator>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!---->
    </section>
</main>

<p-dialog
    [(visible)]="displayDialog"
    header="Thêm bảng chấm công tổng hợp"
    [modal]="true"
    [style]="{ width: '800px' }"
    [closable]="true"
    (onHide)="closeDialogAdd()"
>
    <form [formGroup]="detailForm">
        <div class="p-fluid">
            <div class="p-field">
                <label class="labelip" for="treeData"
                    >Đơn vị <span class="red-asterisk">*</span></label
                >
                <p-treeSelect
                    [options]="treeData"
                    formControlName="organizationId"
                    [placeholder]="'Chọn đơn vị'"
                    [showClear]="true"
                    [style]="{ width: '100%' }"
                    [filter]="true"
                    filterPlaceholder="Tìm kiếm"
                    (onNodeSelect)="onOrganizationChange($event)"
                ></p-treeSelect>
                <div
                    *ngIf="
                        (detailForm.get('organizationId')?.invalid &&
                            (detailForm.get('organizationId')?.dirty ||
                                detailForm.get('organizationId')?.touched)) ||
                        showErrorOrganizationId
                    "
                >
                    <div
                        *ngIf="detailForm.get('organizationId')?.errors?.['required']"
                        class="error-message"
                    >
                        Đơn vị không được bỏ trống
                    </div>
                </div>
            </div>

            <div class="p-field mt-3">
                <label class="labelip" for="summaryTimesheetNameStaffPositions"
                    >Vị trí <span class="red-asterisk">*</span></label
                >
                <p-multiSelect
                    class="custom-multiselect"
                    [options]="staffPosition"
                    formControlName="summaryTimesheetNameStaffPositions"
                    placeholder="Chọn vị trí"
                    optionLabel="name"
                    display="chip"
                    [showClear]="true"
                    [style]="{ width: '100%' }"
                    (onChange)="onStaffPositionChange($event)"
                >
                </p-multiSelect>
                <div
                    *ngIf="
                        (detailForm.get('summaryTimesheetNameStaffPositions')
                            ?.invalid &&
                            (detailForm.get(
                                'summaryTimesheetNameStaffPositions'
                            )?.dirty ||
                                detailForm.get(
                                    'summaryTimesheetNameStaffPositions'
                                )?.touched)) ||
                        showErrorDetailTimesheet
                    "
                >
                    <div
                        *ngIf="detailForm.get('summaryTimesheetNameStaffPositions')?.errors?.['required']"
                        class="error-message"
                    >
                        Vị trí không được bỏ trống
                    </div>
                </div>
            </div>

            <div class="p-field mt-3">
                <label class="labelip" for="value"
                    >Tên bảng chấm công
                    <span class="red-asterisk">*</span></label
                >
                <input
                    pInputText
                    type="text"
                    formControlName="timekeepingSheetName"
                    placeholder="Nhập thông tin"
                />
                <div
                    *ngIf="
                        (detailForm.get('timekeepingSheetName')?.invalid &&
                            (detailForm.get('timekeepingSheetName')?.dirty ||
                                detailForm.get('timekeepingSheetName')
                                    ?.touched)) ||
                        showErrorTimekeepingSheetName
                    "
                >
                    <div
                        *ngIf="detailForm.get('timekeepingSheetName')?.errors?.['required']"
                        class="error-message"
                    >
                        Tên không được bỏ trống
                    </div>
                </div>
            </div>

            <div class="p-field mt-3">
                <label class="labelip" for="timekeepingMethod"
                    >Danh sách bảng chấm công chi tiết
                    <span class="red-asterisk">*</span></label
                >
                <div *ngIf="validateCheckBox == true">
                    <div style="color: red">
                        Bảng chấm công chi tiết phải chọn ít nhất 1 bảng
                    </div>
                </div>
                <p-table
                    [value]="detailTimesheet"
                    [paginator]="true"
                    [rows]="10"
                    [responsiveLayout]="'scroll'"
                    [scrollable]="true"
                    [scrollHeight]="'180px'"
                >
                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width: 1%">
                                <p-checkbox
                                    [binary]="true"
                                    [(ngModel)]="allSelected"
                                    [ngModelOptions]="{ standalone: true }"
                                    (ngModelChange)="selectAll($event)"
                                >
                                </p-checkbox>
                            </th>
                            <th style="width: 10%">Tên bảng chấm công</th>
                            <th style="width: 5%">Thời gian</th>
                            <th style="width: 10%">Đơn vị</th>
                        </tr>
                    </ng-template>
                    <ng-template
                        pTemplate="body"
                        let-item
                        let-rowIndex="rowIndex"
                    >
                        <tr [pSelectableRow]="item">
                            <td>
                                <p-checkbox
                                    [binary]="true"
                                    [(ngModel)]="selectedItems[rowIndex]"
                                    [ngModelOptions]="{ standalone: true }"
                                    (ngModelChange)="updateSelectAllState()"
                                >
                                </p-checkbox>
                            </td>
                            <td>{{ item.timekeepingSheetName }}</td>
                            <td>
                                {{ item.startDate | date : "dd/MM/yyyy" }} -
                                {{ item.endDate | date : "dd/MM/yyyy" }}
                            </td>
                            <!-- <td>{{ item.timekeepingMethod === 0 ? 'Theo giờ' : 'Theo ngày' }}</td> -->
                            <td>
                                <span *ngIf="item.positionNames.length <= 100">
                                    {{ item.positionNames }}
                                </span>
                                <span *ngIf="item.positionNames.length > 100">
                                    <span *ngIf="!expandedRows[rowIndex]">
                                        {{
                                            item.positionNames | slice : 0 : 100
                                        }}
                                        ...
                                        <a
                                            href="#"
                                            (click)="
                                                toggleRow(rowIndex, $event)
                                            "
                                            >Xem thêm</a
                                        >
                                    </span>
                                    <span *ngIf="expandedRows[rowIndex]">
                                        {{ item.positionNames }}
                                        <a
                                            href="#"
                                            (click)="
                                                toggleRow(rowIndex, $event)
                                            "
                                            >Ẩn bớt</a
                                        >
                                    </span>
                                </span>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>
    </form>

    <p-footer>
        <button
            pButton
            label="Hủy"
            class="p-button-secondary"
            (click)="closeDialogAdd()"
        ></button>

        <button
            style="margin-left: 10px"
            pButton
            label="Lưu"
            class="p-button-primary"
            (click)="onSubmit()"
        ></button>
    </p-footer>
</p-dialog>
